---
alwaysApply: true
---

# Pediatric Clinic Management App - Custom Development Rules

A production-ready pediatric clinic management system built with Next.js 16, TypeScript, Bun, tRPC, Prisma, and Better Auth.

## Features

 **Framework**: Next.js 16 with App Router and React 19
- **Runtime**: Bun (for faster development and production)
- **Language**: TypeScript 5 (strict mode enabled)
- **Database**: PostgreSQL via Prisma ORM
- **API Layer**: tRPC with React Query (end-to-end type safety)
- **Authentication**: Better Auth with pediatric-specific roles
- **Styling**: Tailwind CSS 4 + shadcn/ui components
- **Charts**: Recharts for growth charts and analytics
- **Icons**: Lucide React (medical icons from `lucide-react`)
- **Forms**: TanStack Form + Zod validation
- **Date Handling**: date-fns (for age calculations)
- **PDF Generation**: React-PDF (for prescriptions, reports)
- **TypeScript** for type safety
- **Prisma ORM** with PostgreSQL (Supabase)
- **Better Auth** - Multiple authentication methods:
  - Email/password, OAuth (Google, GitHub, Microsoft)
  - Magic links, Passkeys (WebAuthn), OTP
  - Two-Factor Authentication (2FA/TOTP)
  - Enterprise SSO (SAML, OKTA)
- **tRPC** for end-to-end type safety with React Query
- **RBAC System** with 6-30+ permission levels (Owner, Admin, Member, Viewer roles)
- **Clinic Management** with multi-tenant architecture:
  - Clinic templates (clone clinics with roles/permissions)
  - Clinic archiving (archive/restore with audit logging)
  - Invitation links (shareable links with usage limits)
  - Bulk member operations (invite/update/remove multiple members)
  - User activity history (paginated audit logs)
  - Clinic usage metrics (member activity, invitations, analytics)
- **Advanced Permission Management**:
  - Permission browser with categorized permissions
  - Role editor for custom roles
  - Granular permission system (clinic, member, role, content, settings)
  - Permission checker utilities
- **API Key Management**:
  - Secure API key generation with SHA-256 hashing
  - Key expiration (7, 30, 90, 365 days, or never)
  - Usage tracking (last used timestamp)
  - One-time key display on creation
- **Admin Dashboard**:
  - User management (search, ban/unban, delete)
  - User impersonation with audit logging (1-hour sessions)
  - System statistics and metrics
  - Audit logs with filtering and CSV export
  - Environment-based admin access control (ADMIN_EMAILS)
  - Maintenance mode banner (site-wide notifications with scheduled end times)
  - Theme management (switch between available themes)
- **Analytics Dashboard**:
  - User growth charts with Recharts
  - Activity metrics and feeds
  - Statistics cards with real-time data
  - Customizable time ranges (7-90 days)
- **Settings Pages** (5 complete pages):
  - Profile (avatar upload, bio, timezone, language)
  - Account (email change, password change, delete account)
  - Security (2FA, sessions, passkeys)
  - Team (invite members, role assignment, pending invitations)
  - Notifications (7 categories with email/in-app toggles)
- **Email Infrastructure**:
  - Resend integration with React Email
  - Fully integrated with Better Auth hooks (automatic email sending)
  - 6 templates: welcome, verification, password-reset, magic-link, invitation, 2FA
  - EmailService class for centralized email sending
  - Email preview route for development
  - Welcome emails sent automatically after signup
- **In-app Notifications System**:
  - Notifications bell dropdown in header with unread count badge
  - Real-time polling (30s) with toast alerts via `useRealtimeNotifications`
  - Full notification management (read, delete, mark all as read)
  - Five hooks: `useNotifications`, `useRealtimeNotifications`, `useRealtime`, `useSessionData`, `usePresence`

- **Tailwind CSS 4** for styling
- **shadcn/ui** component library (50+ components)
- **Motion Primitives** - 10 custom animation components
- **MDX Support** for rich content authoring
- **Dark/Light mode** with next-themes
- **Responsive design** with mobile-first approach
- **SEO optimized** with proper metadata
- **Content management** through TypeScript data files
- **Modern UI patterns** with sidebar navigation
- **Toast notifications** with Sonner
- **Vercel Analytics** integration
- **Code quality** with Biome and Oxlint
- **Git hooks** with Husky for pre-commit formatting and linting
- **Production Ready**:
  - Error boundaries (global, root, dashboard, admin)
  - Loading skeletons with React Suspense
  - Rate limiting (3 tiers: default, strict, auth)
  - Security headers (HSTS, CSP, X-Frame-Options, etc.)
  - User impersonation system with audit logging

## Getting Started

### Prerequisites

- Node.js 18+ and bun
- PostgreSQL database (Supabase recommended)
- Resend account (optional - for emails)

### Installation

1. Clone the repository:
```bash
git clone https://github.com/yourcompany/saas-template.git
cd saas-template
```

2. Install dependencies:
```bash
bun install
```

3. Set up environment variables:
```bash
cp .env.local.example .env.local
```

Edit `.env.local` and fill in all required variables.

4. Set up the database:
```bash
# Generate Prisma client
bun db:generate

# Run migrations
bun db:migrate

# Or push schema directly (development only)
bun db:push
```

5. Configure admin access (optional):

Add your email to `.env.local`:
```env
ADMIN_EMAILS="your-email@example.com"
```

6. Run the development server:
```bash
bun dev
```

7. Open [http://localhost:3000](http://localhost:3000) in your browser

## Project Structure

```
├── app/                           # Next.js App Router
│   ├── (auth)/                    # Authentication pages
│   │   ├── login/, signup/, forgot-password/, etc.
│   ├── (dashboard)/               # Protected dashboard routes
│   │   ├── page.tsx               # Dashboard with analytics
│   │   ├── clinic/             # Clinic-specific routes
│   │   │   ├── settings/          # Clinic settings page
│   │   │   ├── roles/             # Roles & Permissions management
│   │   │   └── api-keys/          # API Keys management
│   │   ├── clinics/
│   │   ├── notifications/
│   │   └── settings/              # Settings pages (5 pages)
│   │       ├── profile/
│   │       ├── account/           # Account settings with activity log
│   │       ├── security/
│   │       ├── team/
│   │       ├── notifications/
│   │       └── clinics/        # Archived clinics management
│   │           └── archived/
│   ├── (admin)/                   # Admin route group
│   │   └── admin/
│   │       ├── layout.tsx         # Admin layout with access control
│   │       ├── page.tsx           # Admin dashboard
│   │       ├── users/             # User management
│   │       ├── audit/             # Audit logs
│   │       ├── themes/            # Theme management
│   │       ├── maintenance/       # Maintenance mode
│   │       └── emails/            # Email templates
│   ├── invite/                    # Public invitation routes
│   │   └── [token]/               # Accept invite link
│   ├── features/                  # Features/Products section
│   │   ├── [slug]/               # Dynamic feature pages
│   │   └── data.ts               # Features data
│   ├── docs/                      # Documentation/Guides section
│   │   ├── [slug]/               # Dynamic documentation pages
│   │   └── data.ts               # Documentation data
│   ├── blog/                      # Blog posts
│   │   ├── [slug]/               # Dynamic blog post pages
│   │   └── data.ts               # Blog posts data
│   ├── api/                       # API routes
│   │   ├── auth/[...all]/         # Better Auth routes
│   │   ├── trpc/[trpc]/           # tRPC routes
│   │   └── email/preview/         # Email template preview (dev only)
│   ├── layout.tsx                 # Root layout
│   ├── page.tsx                   # Homepage
│   └── globals.css                # Global styles
├── components/                     # React components
│   ├── admin/                     # Admin components
│   │   ├── users-table.tsx
│   │   ├── audit-log-table.tsx
│   │   ├── impersonation-banner.tsx
│   │   ├── theme-manager.tsx
│   │   └── maintenance-manager.tsx
│   ├── maintenance-banner.tsx     # Site-wide maintenance banner
│   ├── maintenance-banner-wrapper.tsx  # Server component wrapper
│   ├── analytics/                 # Analytics components
│   │   ├── stats-card.tsx
│   │   ├── user-growth-chart.tsx
│   │   └── activity-feed.tsx
│   ├── settings/                  # Settings components
│   │   ├── profile-settings-form.tsx
│   │   ├── email-change-form.tsx
│   │   ├── password-change-form.tsx
│   │   ├── delete-account-form.tsx
│   │   ├── team-members-table.tsx
│   │   ├── invite-member-dialog.tsx
│   │   ├── pending-invitations.tsx
│   │   └── notification-preferences.tsx
│   ├── auth/                      # Authentication components
│   ├── clinic/                 # Clinic management
│   │   ├── api-keys-table.tsx
│   │   ├── create-api-key-dialog.tsx
│   │   ├── clone-clinic-dialog.tsx
│   │   ├── archive-clinic-dialog.tsx
│   │   ├── archived-clinics.tsx
│   │   ├── usage-dashboard.tsx
│   │   ├── activity-log.tsx
│   │   └── clinic-settings-form.tsx
│   ├── rbac/                      # RBAC components
│   │   ├── permission-browser.tsx
│   │   ├── role-editor-dialog.tsx
│   │   └── roles-table.tsx
│   ├── notifications/             # Notification components
│   │   └── notifications-dropdown.tsx  # Bell icon dropdown with full management
│   ├── upload/                    # File upload components
│   │   ├── image-upload.tsx       # Reusable image upload with preview
│   │   └── file-upload.tsx        # Generic file upload with drag-and-drop
│   ├── user/                      # User components
│   │   └── user-avatar-menu.tsx   # User dropdown menu (in PageHeader)
│   ├── ui/                        # shadcn/ui components (50+)
│   ├── motion-primitives/         # Custom animation components (10)
│   ├── app-sidebar.tsx            # Main navigation with settings & admin
│   ├── nav-main.tsx               # Main navigation items
│   ├── nav-secondary.tsx          # Secondary navigation (supports onClick)
│   ├── nav-user.tsx               # User navigation (sidebar footer)
│   ├── page-header.tsx            # Header: breadcrumbs, notifications, theme, user menu
│   ├── feedback-dialog.tsx        # Feedback form dialog
│   └── support-dialog.tsx         # Support request dialog
├── emails/                        # React Email templates
│   ├── components/                # Email components
│   │   ├── email-layout.tsx
│   │   ├── email-header.tsx
│   │   └── email-footer.tsx
│   ├── welcome.tsx                # Auto-sent after signup
│   ├── verification.tsx           # Auto-sent on signup
│   ├── password-reset.tsx         # Auto-sent on reset request
│   ├── magic-link.tsx             # Auto-sent on magic link auth
│   ├── invitation.tsx             # Sent on team invitation
│   └── two-factor.tsx             # Auto-sent for 2FA
├── server/                        # Server-side code
│   └── api/                       # tRPC routers
│       ├── trpc.ts                # tRPC setup
│       └── routers/               # tRPC routers
│           ├── _app.ts            # Router aggregation
│           ├── user.ts            # User operations, activity log
│           ├── clinic.ts       # Clinic CRUD, cloning, archiving, usage
│           ├── permissions.ts     # RBAC, roles, permissions
│           ├── invitations.ts     # Invites, bulk operations, invite links
│           ├── notifications.ts   # Notifications (list, read, delete)
│           ├── api-keys.ts        # API key management
│           ├── analytics.ts       # Analytics router
│           ├── admin.ts           # Admin router
│           ├── theme.ts           # Theme management
│           ├── maintenance.ts     # Maintenance mode
│           └── feedback.ts        # Feedback and support
├── lib/                           # Utility functions
│   ├── auth/                      # Better Auth configuration
│   │   ├── config.ts              # Better Auth + email hooks
│   │   ├── auth-helpers.ts
│   │   ├── admin-helpers.ts       # Admin access control
│   │   └── impersonation.ts       # User impersonation system
│   ├── trpc/                      # tRPC client/server
│   ├── rbac/                      # RBAC utilities
│   ├── permissions/               # Permission system
│   │   ├── constants.ts           # Permission definitions by category
│   │   └── checker.ts             # Permission checking utilities
│   ├── email/                     # Email utilities
│   │   └── service.ts             # EmailService class
│   ├── maintenance/               # Maintenance mode utilities
│   │   └── server.ts              # Maintenance mode server functions
│   ├── supabase/                  # Supabase clients
│   ├── rate-limit.ts              # Rate limiting system
│   ├── prisma.ts                  # Prisma client
│   ├── constants.ts               # App constants
│   ├── env.ts                     # Environment validation
│   └── utils.ts                   # Utility functions
├── prisma/                        # Prisma schema
│   └── schema.prisma              # Database schema
├── hooks/                         # Custom React hooks
│   ├── use-auth.ts                # Combined session + user (prefer this)
│   ├── use-session.ts             # Session-only hook
│   ├── use-notifications.ts       # Fetch unread notifications
│   ├── use-realtime-notifications.ts  # Polling with toast alerts (active)
│   ├── use-realtime.ts            # Supabase Realtime (production-ready)
│   ├── use-presence.ts            # User presence (Supabase-ready)
│   ├── use-media-query.ts
│   ├── use-mobile.ts
│   └── useClickOutside.tsx
├── mdx-components.tsx             # MDX component configuration
├── middleware.ts                  # Next.js middleware
├── .husky/                        # Git hooks
│   └── pre-commit                 # Pre-commit hook
├── biome.json                     # Biome configuration
├── .oxlintrc.json                 # Oxlint configuration
└── public/                        # Static assets
```

## Customization

### 1. Update Branding

Edit `/lib/constants.ts` to update:
- Company name
- URLs (website, social media, etc.)
- Contact information

### 2. Update Metadata

Edit `/app/layout.tsx` to update:
- Site title and description
- SEO metadata
- Social media cards (OpenGraph, Twitter)

### 3. Add Content

Add your content in the respective data files:
- Features: `/app/features/data.ts`
- Documentation: `/app/docs/data.ts`
- Blog posts: `/app/blog/data.ts`

You can also add MDX files for blog posts in `/app/blog/[slug]/page.mdx` for rich content authoring.

### 4. Customize Colors

Edit `/app/globals.css` to update CSS variables for theming.

## Tech Stack

- **Framework:** Next.js 16 with App Router
- **Language:** TypeScript 5
- **Database:** PostgreSQL via Prisma ORM
- **Authentication:** Better Auth (7 auth methods)
- **API:** tRPC with React Query
- **Storage:** Supabase Storage (optional)
- **Realtime:** Supabase Realtime (optional)
- **Email:** React Email + Resend
- **Styling:** Tailwind CSS 4
- **UI Components:** shadcn/ui (50+ Radix UI components)
- **Charts:** Recharts for data visualization
- **Icons:** Lucide React
- **Theme:** next-themes (dark/light mode)
- **Fonts:** Geist & Geist Mono (from next/font)
- **Animations:** Motion (Framer Motion)
- **Forms:** React Hook Form + Zod validation
- **Content:** MDX with @next/mdx
- **Markdown:** react-markdown + remark-gfm
- **Code Highlighting:** Shiki
- **Toast Notifications:** Sonner
- **Analytics:** Vercel Analytics
- **Date Handling:** date-fns
- **Code Quality:** Biome 2.3.6 (formatting, import clinic, unused import removal)
- **Linting:** Oxlint 1.29.0 (fast Rust-based linter)
- **Git Hooks:** Husky 9.1.7

## Scripts

```bash
# Development
bun dev         # Start development server
bun build       # Build for production
bun start       # Start production server

# Database
bun db:generate # Generate Prisma client
bun db:migrate  # Run database migrations
bun db:push     # Push schema to database (dev only)
bun db:studio   # Open Prisma Studio

# Code Quality
bun lint        # Run Oxlint to check for linting issues
bun lint:fix    # Run Oxlint with auto-fix
bun format      # Format code, sort imports, and remove unused imports with Biome
bun pre-commit  # Run formatting and linting (used by Husky)
```

## Code Quality

This template uses modern code quality tools:

- **Biome** - Handles formatting, import sorting, and automatically removes unused imports
- **Oxlint** - Fast Rust-based linter for catching code issues
- **Husky** - Git hooks that automatically format and lint code before commits

The pre-commit hook will automatically:
- Format your code with Biome
- Sort and organize imports
- Remove unused imports
- Run Oxlint to check for linting issues

Configuration files:
- `biome.json` - Biome configuration for formatting and linting rules
- `.oxlintrc.json` - Oxlint configuration for linting rules
- `.husky/pre-commit` - Pre-commit hook script

**Note:** This project uses `bun` as the package manager. You can use `npm` or `yarn` as alternatives.

## Production Features

### Rate Limiting
Three-tier rate limiting system ready for production:
```typescript
import { checkRateLimit, strictRateLimiter, authRateLimiter } from '@/lib/rate-limit'

// Default: 100 requests per 15 minutes
await checkRateLimit()

// Strict: 10 requests per 15 minutes
await checkRateLimit(strictRateLimiter)

// Auth: 5 attempts per 15 minutes
await checkRateLimit(authRateLimiter)
```

### Error Boundaries
Comprehensive error handling with recovery:
- `app/global-error.tsx` - Critical errors
- `app/error.tsx` - Root errors
- `app/(dashboard)/error.tsx` - Dashboard errors
- `app/(admin)/admin/error.tsx` - Admin errors

### Loading States
React Suspense with loading skeletons:
- `app/(dashboard)/loading.tsx`
- `app/(dashboard)/settings/loading.tsx`
- `app/(admin)/admin/loading.tsx`

### Security Headers
Applied via `proxy.ts`:
- HSTS, CSP, X-Frame-Options
- X-Content-Type-Options, X-XSS-Protection
- Referrer-Policy, Permissions-Policy

### User Impersonation
Admins can impersonate users:
- Access: Admin → Users → ⋮ → "Impersonate User"
- 1-hour session expiry
- Complete audit logging
- Visual banner when active

## Deployment

This template is optimized for deployment on [Vercel](https://vercel.com):

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new)

### Known Issues
**Next.js 16 Build Issue**: Production builds have Turbopack errors. This is a pre-existing Next.js 16.0.3 issue.
- **Solution**: Use Next.js 15 (`bun add next@15`) or wait for Next.js 16.1+
- **Note**: Development server works perfectly
- See `BUILD_NOTES.md` for details

## Motion Primitives

This template includes 10 custom motion primitives for enhanced UI interactions:

- **Animated Background** - Dynamic background animations
- **Magnetic** - Elements that follow cursor movement
- **Morphing Dialog** - Smooth dialog transitions
- **Progressive Blur** - Gradual blur effects
- **Scroll Progress** - Visual scroll indicators
- **Spotlight** - Focused lighting effects
- **Text Effect** - Animated text effects
- **Text Loop** - Looping text animations
- **Text Morph** - Morphing text transitions
- **Tilt** - 3D tilt effects on hover

These components are located in `/components/motion-primitives/` and can be imported and used throughout your application.

---

Built with Next.js 15, React 19, TypeScript, and shadcn/ui
